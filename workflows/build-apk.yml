name: Final APK Build

on:
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug mode'
        required: false
        default: 'true'

jobs:
  build:
    runs-on: ubuntu-20.04
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v3
      
    - name: ğŸ Setup Python 3.8
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
        
    - name: â˜• Setup Java 8
      uses: actions/setup-java@v3
      with:
        java-version: '8'
        distribution: 'temurin'
        
    - name: ğŸ“¦ Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          ~/.buildozer
        key: ${{ runner.os }}-buildozer-${{ hashFiles('**/buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-
          
    - name: ğŸ”§ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          unzip \
          openjdk-8-jdk \
          autoconf \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          cmake \
          libffi-dev \
          libssl-dev \
          python3-distutils
          
    - name: ğŸ Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install buildozer==1.4.0 cython==0.29.33
        
    - name: ğŸ“± Create test application
      run: |
        mkdir -p multimedia_app
        cd multimedia_app
        
        # Create main.py
        cat > main.py << 'EOF'
from kivy.app import App
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.label import Label
from kivy.uix.button import Button

class MultimediaControllerApp(App):
    def build(self):
        # Main layout
        main_layout = BoxLayout(orientation='vertical', padding=20, spacing=15)
        
        # Title
        title_label = Label(
            text='æ–‡æ—…å¤šåª’ä½“æ¼”å‡ºæ§åˆ¶ç³»ç»Ÿ\nç§»åŠ¨ç«¯æ§åˆ¶å™¨',
            font_size='18sp',
            size_hint_y=0.25,
            halign='center'
        )
        title_label.bind(size=title_label.setter('text_size'))
        
        # Control buttons layout
        button_layout = BoxLayout(orientation='vertical', spacing=10, size_hint_y=0.5)
        
        # Test button
        test_btn = Button(text='ç³»ç»Ÿæµ‹è¯•', size_hint_y=0.5)
        test_btn.bind(on_press=self.on_test_press)
        
        # Status button
        status_btn = Button(text='çŠ¶æ€æ£€æŸ¥', size_hint_y=0.5)
        status_btn.bind(on_press=self.on_status_press)
        
        button_layout.add_widget(test_btn)
        button_layout.add_widget(status_btn)
        
        # Status display
        self.status_label = Label(
            text='ç³»ç»Ÿå°±ç»ª\nç­‰å¾…æ“ä½œæŒ‡ä»¤',
            font_size='14sp',
            size_hint_y=0.25,
            halign='center'
        )
        self.status_label.bind(size=self.status_label.setter('text_size'))
        
        # Add all widgets to main layout
        main_layout.add_widget(title_label)
        main_layout.add_widget(button_layout)
        main_layout.add_widget(self.status_label)
        
        return main_layout
    
    def on_test_press(self, instance):
        self.status_label.text = 'âœ… ç³»ç»Ÿæµ‹è¯•å®Œæˆ\nAPKæ„å»ºæˆåŠŸ\nç§»åŠ¨ç«¯æ§åˆ¶å™¨æ­£å¸¸è¿è¡Œ'
    
    def on_status_press(self, instance):
        self.status_label.text = 'ğŸ“± ç§»åŠ¨ç«¯çŠ¶æ€ï¼šæ­£å¸¸\nğŸ”— è¿æ¥çŠ¶æ€ï¼šå°±ç»ª\nâš¡ ç³»ç»Ÿç‰ˆæœ¬ï¼šv1.0'

if __name__ == '__main__':
    MultimediaControllerApp().run()
EOF

        # Create buildozer.spec
        cat > buildozer.spec << 'EOF'
[app]
title = æ–‡æ—…å¤šåª’ä½“æ¼”å‡ºæ§åˆ¶
package.name = multimediacontroller
package.domain = com.showcontrol.mobile
source.dir = .
source.include_exts = py
version = 1.0
requirements = python3,kivy
orientation = portrait
fullscreen = 0

[buildozer]
log_level = 2

# Android specific
android.permissions = INTERNET,ACCESS_NETWORK_STATE
android.api = 28
android.minapi = 21
android.sdk = 28
android.ndk = 21b
android.ndk_api = 21
android.accept_sdk_license = True
android.archs = armeabi-v7a
android.allow_backup = True
android.private_storage = True
EOF

        echo "âœ… Application files created"
        ls -la
        
    - name: ğŸ”¨ Build APK
      working-directory: multimedia_app
      run: |
        echo "ğŸš€ Starting APK build process..."
        
        # Set environment variables
        export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
        export PATH=$JAVA_HOME/bin:$PATH
        export ANDROID_HOME=$ANDROID_SDK_ROOT
        
        # Show environment info
        echo "ğŸ“‹ Environment Information:"
        echo "Java: $(java -version 2>&1 | head -1)"
        echo "Python: $(python --version)"
        echo "Buildozer: $(buildozer --version)"
        echo "Working directory: $(pwd)"
        
        # Clean previous builds
        rm -rf .buildozer bin
        
        # Build APK
        echo "ğŸ”¨ Building APK..."
        buildozer android debug
        
    - name: ğŸ“‹ List build results
      working-directory: multimedia_app
      run: |
        echo "ğŸ“ Build directory contents:"
        ls -la
        
        echo "ğŸ“± Looking for APK files:"
        find . -name "*.apk" -type f -exec ls -lh {} \;
        
        if [ -d "bin" ]; then
          echo "ğŸ“¦ Bin directory contents:"
          ls -la bin/
        else
          echo "âš ï¸ No bin directory found"
        fi
        
    - name: ğŸ“¤ Upload APK
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: multimedia-controller-apk-${{ github.run_number }}
        path: |
          multimedia_app/bin/*.apk
          multimedia_app/.buildozer/android/platform/build-*/build/outputs/apk/**/*.apk
        retention-days: 30
        
    - name: ğŸ“Š Build Summary
      run: |
        echo "ğŸ‰ Build Process Completed!"
        echo "================================"
        
        APK_COUNT=$(find multimedia_app -name "*.apk" -type f | wc -l)
        
        if [ $APK_COUNT -gt 0 ]; then
          echo "âœ… Success: $APK_COUNT APK file(s) generated"
          echo "ğŸ“± APK files:"
          find multimedia_app -name "*.apk" -type f -exec basename {} \;
          echo ""
          echo "ğŸ“¥ Download the APK from the 'Artifacts' section above"
          echo "ğŸ“² Install on Android device to test the app"
        else
          echo "âŒ No APK files were generated"
          echo "ğŸ“‹ Check the build logs above for errors"
        fi
