name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: â˜• Set up JDK 8
      uses: actions/setup-java@v3
      with:
        java-version: '8'
        distribution: 'temurin'
        
    - name: ğŸ“¦ Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: ğŸ“¦ Cache Buildozer global directory
      uses: actions/cache@v4
      with:
        path: ~/.buildozer
        key: ${{ runner.os }}-buildozer-${{ hashFiles('**/buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-

    - name: ğŸ“¦ Cache Buildozer directory
      uses: actions/cache@v4
      with:
        path: .buildozer
        key: ${{ runner.os }}-buildozer-local-${{ hashFiles('**/buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-local-
          
    - name: ğŸ”§ Install system dependencies
      run: |
        sudo apt-get update

        # å®‰è£…åŸºç¡€ä¾èµ–
        sudo apt-get install -y \
          python3-pip \
          build-essential \
          git \
          unzip \
          openjdk-8-jdk \
          autoconf \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          cmake \
          libffi-dev \
          libssl-dev

        # å°è¯•å®‰è£… libtinfo (å…¼å®¹ä¸åŒUbuntuç‰ˆæœ¬)
        sudo apt-get install -y libtinfo6 || sudo apt-get install -y libtinfo5 || echo "Warning: libtinfo not found, continuing..."
          
    - name: ğŸ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython
        
    - name: ğŸ“ Prepare project files
      run: |
        echo "ğŸ“‹ Repository contents:"
        ls -la

        echo "ğŸ“‹ æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„é¡¹ç›®ç›®å½•:"
        find . -maxdepth 2 -type d -name "*GMA*" -o -name "*mobile*" -o -name "*app*" | head -10

        echo "ğŸ“‹ æŸ¥æ‰¾åŒ…å«buildozer.specçš„ç›®å½•:"
        find . -name "buildozer.spec" -type f

        # é¡¹ç›®æ–‡ä»¶åœ¨ "GMA2_UDP_Tool - å‰¯æœ¬" ç›®å½•ä¸­
        PROJECT_DIR="GMA2_UDP_Tool - å‰¯æœ¬"

        if [ -d "$PROJECT_DIR" ]; then
          echo "âœ… Found project directory: $PROJECT_DIR"
          echo "ğŸ“‹ Project directory contents:"
          ls -la "$PROJECT_DIR/"

          # åˆ›å»ºæ„å»ºç›®å½•å¹¶å¤åˆ¶æ–‡ä»¶
          mkdir -p build_dir

          # å¤åˆ¶ä¸»è¦æ–‡ä»¶
          if [ -f "$PROJECT_DIR/main.py" ]; then
            cp "$PROJECT_DIR/main.py" build_dir/
            echo "âœ… Copied main.py"
          else
            echo "âŒ main.py not found in $PROJECT_DIR"
            exit 1
          fi

          # å¤åˆ¶æ‰€æœ‰Pythonæ–‡ä»¶
          cp "$PROJECT_DIR"/*.py build_dir/ 2>/dev/null || echo "âš ï¸ Some Python files may not exist"

          # å¤åˆ¶å…¶ä»–å¿…è¦æ–‡ä»¶
          if [ -d "$PROJECT_DIR/Video" ]; then
            cp -r "$PROJECT_DIR/Video" build_dir/
            echo "âœ… Copied Video directory"
          fi

          if [ -d "$PROJECT_DIR/music" ]; then
            cp -r "$PROJECT_DIR/music" build_dir/
            echo "âœ… Copied music directory"
          fi

          if [ -f "$PROJECT_DIR/buildozer.spec" ]; then
            cp "$PROJECT_DIR/buildozer.spec" build_dir/
            echo "âœ… Copied buildozer.spec"
          else
            echo "âŒ buildozer.spec not found in $PROJECT_DIR"
            exit 1
          fi

        else
          echo "âŒ Project directory not found: $PROJECT_DIR"
          echo "Available directories:"
          ls -la
          exit 1
        fi

        echo "ğŸ“‹ Build directory contents:"
        ls -la build_dir/
        
    - name: ğŸ”¨ Build APK with Buildozer
      working-directory: build_dir
      run: |
        echo "ğŸš€ Starting APK build..."
        echo "Java version:"
        java -version
        echo "Python version:"
        python --version
        echo "Buildozer version:"
        buildozer --version
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
        export PATH=$JAVA_HOME/bin:$PATH
        
        # æ„å»ºAPK
        buildozer android debug
        
    - name: ğŸ“± List generated files
      working-directory: build_dir
      run: |
        echo "ğŸ“ Build directory contents:"
        find . -name "*.apk" -type f
        ls -la bin/ || echo "No bin directory found"
        
    - name: ğŸ“¤ Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: multimedia-show-controller-apk
        path: build_dir/bin/*.apk
        retention-days: 30
        
    - name: ğŸ“Š Build summary
      run: |
        echo "ğŸ‰ APK Build Summary"
        echo "==================="
        if [ -f "build_dir/bin/*.apk" ]; then
          echo "âœ… APK build successful!"
          echo "ğŸ“± APK files:"
          ls -la build_dir/bin/*.apk
          echo "ğŸ“¦ File size:"
          du -h build_dir/bin/*.apk
        else
          echo "âŒ APK build failed!"
          exit 1
        fi
