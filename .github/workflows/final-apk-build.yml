name: Build Android APK with AIDL Fix

on:
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug mode'
        required: false
        default: 'true'

jobs:
  build-apk:
    runs-on: ubuntu-22.04

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'

    - name: â˜• Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: ï¿½ Install system dependencies with AIDL support
      run: |
        sudo apt-get update

        # å®‰è£…å®Œæ•´çš„Androidå¼€å‘å·¥å…·é“¾
        sudo apt-get install -y \
          python3-pip \
          python3-setuptools \
          python3-distutils \
          build-essential \
          git \
          unzip \
          wget \
          curl \
          openjdk-8-jdk \
          autoconf \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          cmake \
          libffi-dev \
          libssl-dev \
          libc6-dev \
          libstdc++6 \
          libpulse-dev \
          libegl1-mesa-dev \
          libgles2-mesa-dev

        # å®‰è£…Android SDKå‘½ä»¤è¡Œå·¥å…·
        echo "ğŸ“± Installing Android SDK Command Line Tools..."
        mkdir -p $HOME/android-sdk/cmdline-tools
        cd $HOME/android-sdk/cmdline-tools

        # ä¸‹è½½æœ€æ–°çš„å‘½ä»¤è¡Œå·¥å…·
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip
        mv cmdline-tools latest

        # è®¾ç½®ç¯å¢ƒå˜é‡
        export ANDROID_HOME=$HOME/android-sdk
        export ANDROID_SDK_ROOT=$HOME/android-sdk
        export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/30.0.3

        echo "export ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
        echo "export ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
        echo "$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$HOME/android-sdk/platform-tools" >> $GITHUB_PATH
        echo "$HOME/android-sdk/build-tools/30.0.3" >> $GITHUB_PATH

        # æ¥å—è®¸å¯è¯å¹¶å®‰è£…å¿…è¦ç»„ä»¶
        echo "ğŸ“‹ Accepting Android SDK licenses..."
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses

        echo "ğŸ“¦ Installing Android SDK components..."
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
          "platform-tools" \
          "platforms;android-30" \
          "build-tools;30.0.3" \
          "ndk;21.4.7075529"

        echo "âœ… Android SDK setup completed"
        ls -la $ANDROID_HOME/

    - name: ğŸ Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install buildozer==1.5.0 cython==0.29.36

    - name: ğŸ“ Create minimal test app
      run: |
        echo "ğŸ“± Creating minimal Kivy test app..."
        mkdir -p build_dir

        # åˆ›å»ºæœ€ç®€å•çš„main.py
        cat > build_dir/main.py << 'EOF'
from kivy.app import App
from kivy.uix.label import Label

class TestApp(App):
    def build(self):
        return Label(text='æ–‡æ—…å¤šåª’ä½“æ¼”å‡ºæ§åˆ¶\nAPKæ„å»ºæµ‹è¯•æˆåŠŸï¼',
                    font_size='20sp',
                    halign='center')

if __name__ == '__main__':
    TestApp().run()
EOF

        # åˆ›å»ºä¼˜åŒ–çš„buildozer.specï¼Œä½¿ç”¨æ­£ç¡®çš„Android API
        cat > build_dir/buildozer.spec << 'EOF'
[app]
title = æ–‡æ—…å¤šåª’ä½“æ¼”å‡ºæ§åˆ¶
package.name = multimedia_show_controller
package.domain = com.showcontrol.mobile
source.dir = .
source.include_exts = py
version = 1.0.0
requirements = python3,kivy
orientation = portrait

[buildozer]
log_level = 2

# Android specific - ä½¿ç”¨ä¸SDKå®‰è£…åŒ¹é…çš„ç‰ˆæœ¬
android.permissions = INTERNET
android.api = 30
android.minapi = 21
android.sdk = 30
android.ndk = 21.4.7075529
android.ndk_api = 21
android.accept_sdk_license = True
android.archs = armeabi-v7a
android.allow_backup = True
android.private_storage = True
EOF

        echo "ğŸ“‹ Created files:"
        ls -la build_dir/

    - name: ğŸ” Verify AIDL availability
      run: |
        echo "ï¿½ Checking for AIDL tool..."
        export ANDROID_HOME=$HOME/android-sdk
        export ANDROID_SDK_ROOT=$HOME/android-sdk
        export PATH=$PATH:$ANDROID_HOME/build-tools/30.0.3

        # æ£€æŸ¥AIDLå·¥å…·
        which aidl || echo "AIDL not found in PATH"
        ls -la $ANDROID_HOME/build-tools/30.0.3/aidl || echo "AIDL not found in build-tools"

        # æ£€æŸ¥ç¯å¢ƒå˜é‡
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        echo "PATH includes build-tools: $(echo $PATH | grep build-tools || echo 'No')"

    - name: ğŸ”¨ Build APK with Buildozer
      working-directory: build_dir
      run: |
        echo "ğŸš€ Starting APK build..."

        # è®¾ç½®å®Œæ•´çš„ç¯å¢ƒå˜é‡
        export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
        export ANDROID_HOME=$HOME/android-sdk
        export ANDROID_SDK_ROOT=$HOME/android-sdk
        export ANDROID_NDK_HOME=$HOME/android-sdk/ndk/21.4.7075529
        export PATH=$JAVA_HOME/bin:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/30.0.3:$PATH

        echo "ğŸ“‹ Environment Information:"
        echo "Java version:"
        java -version 2>&1 | head -3
        echo "Python version:"
        python --version
        echo "Buildozer version:"
        buildozer --version
        echo "AIDL location:"
        which aidl || echo "AIDL not found"

        # æ¸…ç†ä¹‹å‰çš„æ„å»º
        rm -rf .buildozer bin

        # æ„å»ºAPK
        echo "ğŸ”¨ Building APK..."
        buildozer android debug

    - name: ğŸ“± List generated files
      working-directory: build_dir
      run: |
        echo "ğŸ“ Build directory contents:"
        find . -name "*.apk" -type f -exec ls -lh {} \; || echo "No APK files found"

        if [ -d "bin" ]; then
          echo "ğŸ“¦ Bin directory contents:"
          ls -la bin/
        else
          echo "âŒ No bin directory found"
        fi

    - name: ğŸ“¤ Upload APK artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: multimedia-show-controller-apk
        path: |
          build_dir/bin/*.apk
        retention-days: 30

    - name: ğŸ“Š Build summary
      run: |
        echo "ğŸ‰ APK Build Summary"
        echo "==================="

        cd build_dir
        APK_FILES=$(find . -name "*.apk" -type f)

        if [ -n "$APK_FILES" ]; then
          echo "âœ… APK build successful!"
          echo "ğŸ“± APK files:"
          echo "$APK_FILES" | while read apk; do
            echo "ğŸ“² $(basename "$apk") - $(du -h "$apk" | cut -f1)"
          done
          echo ""
          echo "ï¿½ Download APK from 'Artifacts' section above"
          echo "ğŸ“² Install on Android device to test"
        else
          echo "âŒ APK build failed!"
          echo "ğŸ“‹ Check the build logs above for errors"
          exit 1
        fi
