name: APK Build - Docker Solution

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: cimg/android:2023.10

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup environment
      shell: bash
      run: |
        # Install Python and pip
        sudo apt-get update
        sudo apt-get install -y python3 python3-pip python3-venv

        # Install Python packages globally to avoid venv issues
        sudo pip3 install --upgrade pip setuptools wheel
        sudo pip3 install python-for-android==2022.9.4 cython==0.29.33

        # Verify installation
        echo "Python packages installed:"
        pip3 list | grep -E "(python-for-android|cython)" || echo "Packages not found in list"
        which p4a || echo "p4a not found in PATH"

    - name: Create simple app
      shell: bash
      run: |
        mkdir -p app_build
        cd app_build

        # Create extremely simple main.py
        echo 'print("Hello from Python on Android!")' > main.py
        echo 'import time' >> main.py
        echo 'time.sleep(1)' >> main.py
        echo 'print("App completed successfully!")' >> main.py

        echo "Created main.py:"
        cat main.py

    - name: Build APK with P4A
      working-directory: app_build
      shell: bash
      run: |
        echo "Building APK with P4A..."
        echo "Environment check:"
        java -version
        python3 --version
        p4a --version || echo "p4a not found, trying with full path"

        # Set environment variables
        export ANDROIDAPI="28"
        export NDKAPI="21"

        # Build APK using P4A
        p4a apk --private . --package=com.test.app --name="TestApp" --version=1.0 --bootstrap=service_only --requirements=python3 --arch=armeabi-v7a

    - name: Check results
      working-directory: app_build
      shell: bash
      run: |
        echo "Searching for APK files:"
        find . -name "*.apk" -type f -exec ls -lh {} \; || echo "No APK found"

        # P4A creates APK in dist directory
        if [ -d "dist" ]; then
          echo "Dist directory contents:"
          ls -la dist/
        fi

    - name: Upload APK
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-apk
        path: app_build/dist/*.apk
        retention-days: 30

    - name: Summary
      shell: bash
      run: |
        cd app_build
        if find . -name "*.apk" -type f | grep -q .; then
          echo "üéâ SUCCESS: APK build completed!"
          find . -name "*.apk" -type f -exec basename {} \;
          echo "üì± Download APK from Artifacts section above"
        else
          echo "‚ùå FAILED: No APK generated"
          exit 1
        fi
