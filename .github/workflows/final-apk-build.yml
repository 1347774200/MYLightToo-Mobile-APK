name: Final APK Build

on:
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug mode'
        required: false
        default: 'true'

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python 3.8
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
        
    - name: â˜• Setup Java 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        
    - name: ğŸ”§ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          unzip \
          openjdk-8-jdk \
          autoconf \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          cmake \
          libffi-dev \
          libssl-dev \
          python3-distutils \
          python3-setuptools
          
    - name: ğŸ Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install buildozer==1.5.0 cython==0.29.36
        
    - name: ğŸ“± Create test application
      run: |
        mkdir -p multimedia_app
        cd multimedia_app
        
        cat > main.py << 'EOF'
        from kivy.app import App
        from kivy.uix.boxlayout import BoxLayout
        from kivy.uix.label import Label
        from kivy.uix.button import Button

        class MultimediaControllerApp(App):
            def build(self):
                main_layout = BoxLayout(orientation='vertical', padding=20, spacing=15)
                
                title_label = Label(
                    text='æ–‡æ—…å¤šåª’ä½“æ¼”å‡ºæ§åˆ¶ç³»ç»Ÿ\nç§»åŠ¨ç«¯æ§åˆ¶å™¨',
                    font_size='18sp',
                    size_hint_y=0.3
                )
                
                test_btn = Button(
                    text='ç³»ç»Ÿæµ‹è¯•',
                    size_hint_y=0.2
                )
                test_btn.bind(on_press=self.on_test_press)
                
                self.status_label = Label(
                    text='ç³»ç»Ÿå°±ç»ªï¼Œç­‰å¾…æ“ä½œæŒ‡ä»¤',
                    font_size='14sp',
                    size_hint_y=0.5
                )
                
                main_layout.add_widget(title_label)
                main_layout.add_widget(test_btn)
                main_layout.add_widget(self.status_label)
                
                return main_layout
            
            def on_test_press(self, instance):
                self.status_label.text = 'APKæ„å»ºæˆåŠŸï¼\næ–‡æ—…å¤šåª’ä½“æ¼”å‡ºæ§åˆ¶ç³»ç»Ÿ\nç§»åŠ¨ç«¯æµ‹è¯•å®Œæˆ'

        if __name__ == '__main__':
            MultimediaControllerApp().run()
        EOF

        cat > buildozer.spec << 'EOF'
        [app]
        title = æ–‡æ—…å¤šåª’ä½“æ¼”å‡ºæ§åˆ¶
        package.name = multimediacontroller
        package.domain = com.showcontrol.mobile
        source.dir = .
        source.include_exts = py
        version = 1.0
        requirements = python3,kivy
        orientation = portrait
        fullscreen = 0

        [buildozer]
        log_level = 2

        android.permissions = INTERNET
        android.api = 30
        android.minapi = 21
        android.sdk = 30
        android.ndk = 25b
        android.ndk_api = 21
        android.accept_sdk_license = True
        android.archs = armeabi-v7a
        android.allow_backup = True
        android.private_storage = True
        EOF

        echo "âœ… Application files created successfully"
        ls -la
        
    - name: ğŸ”¨ Build APK
      working-directory: multimedia_app
      run: |
        echo "ğŸš€ Starting APK build process..."
        
        export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
        export PATH=$JAVA_HOME/bin:$PATH
        
        echo "ğŸ“‹ Environment Information:"
        java -version 2>&1 | head -3
        python --version
        buildozer --version
        
        echo "ğŸ§¹ Cleaning previous builds..."
        rm -rf .buildozer bin
        
        echo "ğŸ”¨ Building APK..."
        buildozer android debug
        
    - name: ğŸ“‹ Check build results
      working-directory: multimedia_app
      run: |
        echo "ğŸ“ Build directory contents:"
        ls -la
        
        echo "ğŸ” Searching for APK files:"
        find . -name "*.apk" -type f -exec ls -lh {} \; || echo "No APK files found yet"
        
        if [ -d "bin" ]; then
          echo "ğŸ“¦ Bin directory contents:"
          ls -la bin/
        fi
        
    - name: ğŸ“¤ Upload APK
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: multimedia-controller-apk
        path: |
          multimedia_app/bin/*.apk
        retention-days: 30
        
    - name: ğŸ“Š Build Summary
      run: |
        echo "ğŸ‰ Build Process Completed!"
        echo "================================"
        
        cd multimedia_app
        APK_FILES=$(find . -name "*.apk" -type f)
        
        if [ -n "$APK_FILES" ]; then
          echo "âœ… APK files generated successfully:"
          echo "$APK_FILES" | while read apk; do
            echo "ğŸ“± $(basename "$apk") - $(du -h "$apk" | cut -f1)"
          done
          echo ""
          echo "ğŸ“¥ Download APK from 'Artifacts' section above"
          echo "ğŸ“² Install on Android device to test"
        else
          echo "âŒ No APK files were generated"
          echo "ğŸ“‹ Please check the build logs for errors"
        fi
